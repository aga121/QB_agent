<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="tel"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="tel"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .package-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .package-option {
            flex: 1;
            min-width: 80px;
        }

        .package-option input[type="radio"] {
            display: none;
        }

        .package-option label {
            display: block;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0;
            font-weight: bold;
            color: #666;
        }

        .package-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .package-option label:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 14px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ä¼šå‘˜åˆ—è¡¨åŒºåŸŸ */
        .member-list-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .member-list-section h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .member-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }

        .member-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .member-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .member-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .member-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .member-table tbody tr:hover {
            background: #f8f9fa;
        }

        .member-table .active {
            color: #28a745;
            font-weight: 600;
        }

        .member-table .inactive {
            color: #dc3545;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: #666;
            font-size: 14px;
        }

        /* æ ‡ç­¾åˆ‡æ¢ */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 20px;
            }

            .package-options {
                flex-direction: column;
            }

            .package-option {
                width: 100%;
            }

            .member-table-container {
                max-height: 300px;
            }

            .member-table {
                font-size: 11px;
            }

            .member-table th,
            .member-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘‘ ä¼šå‘˜ç®¡ç†åå°</h1>

        <!-- æ ‡ç­¾æŒ‰é’® -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('activate')">å¼€é€šä¼šå‘˜</button>
            <button class="tab-button" onclick="switchTab('list')">ä¼šå‘˜åˆ—è¡¨</button>
        </div>

        <!-- å¼€é€šä¼šå‘˜å†…å®¹ -->
        <div class="tab-content active" id="activateTab">
            <form id="membershipForm">
            <div class="form-group">
                <label for="phone">æ‰‹æœºå·ç </label>
                <input
                    type="tel"
                    id="phone"
                    name="phone"
                    placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç "
                    pattern="[0-9]{11}"
                    required
                >
            </div>

            <div class="form-group">
                <label>é€‰æ‹©å¥—é¤</label>
                <div class="package-options">
                    <div class="package-option">
                        <input type="radio" id="pkg39" name="package" value="39" checked>
                        <label for="pkg39">39å…ƒ<br><small>æœˆå¡</small></label>
                    </div>
                    <div class="package-option">
                        <input type="radio" id="pkg99" name="package" value="99">
                        <label for="pkg99">99å…ƒ<br><small>å­£å¡</small></label>
                    </div>
                    <div class="package-option">
                        <input type="radio" id="pkg299" name="package" value="299">
                        <label for="pkg299">299å…ƒ<br><small>å¹´å¡</small></label>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-submit">å¼€é€šä¼šå‘˜</button>
        </form>

        <div class="loading" id="loading"></div>
        <div class="message" id="message"></div>
        </div>

        <!-- ä¼šå‘˜åˆ—è¡¨å†…å®¹ -->
        <div class="tab-content" id="listTab">
        <div class="member-list-section" style="margin-top: 0; padding-top: 20px; border-top: none;">
            <h2>ğŸ“‹ ä¼šå‘˜è®°å½•åˆ—è¡¨</h2>
            <div class="member-table-container">
                <table class="member-table">
                    <thead>
                        <tr>
                            <th>æ‰‹æœºå·</th>
                            <th>å¥—é¤ç±»å‹</th>
                            <th>å¼€å§‹æ—¶é—´</th>
                            <th>ç»“æŸæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ›´æ–°æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="memberListBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPage" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ</span>
                <button id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <script>
        const SECRET_KEY = 'usyttnm-uygbmm776sw65doj-suucnnu997sdscerefghhhheedddtgfdl';

        // æ£€æŸ¥ URL å‚æ•°
        function checkAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');

            if (key !== SECRET_KEY) {
                document.body.innerHTML = `
                    <div style="text-align: center; color: white;">
                        <h1 style="font-size: 48px; margin-bottom: 20px;">ğŸš«</h1>
                        <p style="font-size: 18px;">è®¿é—®è¢«æ‹’ç»</p>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // æäº¤è¡¨å•
        document.getElementById('membershipForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const phone = document.getElementById('phone').value.trim();
            const packageEl = document.querySelector('input[name="package"]:checked');
            const packagePrice = packageEl ? packageEl.value : null;

            if (!phone || !packagePrice) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
                return;
            }

            const loadingEl = document.getElementById('loading');
            const submitBtn = document.querySelector('.btn-submit');

            loadingEl.style.display = 'block';
            submitBtn.disabled = true;

            // æ·»åŠ è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶

            try {
                console.log('[å……å€¼] å¼€å§‹è¯·æ±‚ï¼Œå‚æ•°:', { phone, packagePrice });
                console.log('[å……å€¼] User Agent:', navigator.userAgent);

                const response = await fetch('/api/v1/subscription/admin-activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        package: packagePrice,
                        secret_key: SECRET_KEY
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                console.log('[å……å€¼] å“åº”çŠ¶æ€:', response.status);
                console.log('[å……å€¼] å“åº”å¤´:', response.headers);

                // å…ˆæ£€æŸ¥ HTTP çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('[å……å€¼] å“åº”æ•°æ®:', result);

                if (result.status === 'success') {
                    showMessage(`âœ… ä¼šå‘˜å¼€é€šæˆåŠŸï¼${result.message || ''}`, 'success');
                    document.getElementById('phone').value = '';
                    // å¦‚æœåœ¨åˆ—è¡¨æ ‡ç­¾é¡µï¼Œåˆ·æ–°åˆ—è¡¨
                    if (document.getElementById('listTab').classList.contains('active')) {
                        loadMemberList(currentPage);
                    }
                } else {
                    showMessage(`âŒ ${result.detail || result.message || 'å¼€é€šå¤±è´¥'}`, 'error');
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('[å……å€¼] è¯·æ±‚å¤±è´¥:', error);
                console.error('[å……å€¼] é”™è¯¯åç§°:', error.name);
                console.error('[å……å€¼] é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('[å……å€¼] é”™è¯¯å †æ ˆ:', error.stack);

                if (error.name === 'AbortError') {
                    showMessage('âŒ è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
                } else {
                    showMessage(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                }
            } finally {
                loadingEl.style.display = 'none';
                submitBtn.disabled = false;
                console.log('[å……å€¼] è¯·æ±‚ç»“æŸï¼Œloadingå·²éšè—');
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¿é—®æƒé™
        window.addEventListener('DOMContentLoaded', () => {
            if (checkAccess()) {
                // é»˜è®¤ä¸åŠ è½½ä¼šå‘˜åˆ—è¡¨ï¼Œåªæœ‰åˆ‡æ¢åˆ°åˆ—è¡¨æ ‡ç­¾æ—¶æ‰åŠ è½½
            }
        });

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Tab').classList.add('active');

            // å¦‚æœåˆ‡æ¢åˆ°ä¼šå‘˜åˆ—è¡¨ï¼ŒåŠ è½½æ•°æ®
            if (tabName === 'list') {
                loadMemberList(1);
            }
        }

        // ä¼šå‘˜åˆ—è¡¨ç›¸å…³å˜é‡
        let currentPage = 1;
        let totalPages = 1;

        // åŠ è½½ä¼šå‘˜åˆ—è¡¨
        async function loadMemberList(page = 1) {
            try {
                const response = await fetch(`/api/v1/subscription/admin-list?secret_key=${SECRET_KEY}&page=${page}&page_size=50`);
                const result = await response.json();

                if (result.status === 'success') {
                    currentPage = result.data.page;
                    totalPages = result.data.total_pages;
                    renderMemberList(result.data.members);
                    updatePagination();
                } else {
                    console.error('åŠ è½½ä¼šå‘˜åˆ—è¡¨å¤±è´¥:', result.detail);
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šå‘˜åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ä¼šå‘˜åˆ—è¡¨
        function renderMemberList(members) {
            const tbody = document.getElementById('memberListBody');

            if (!members || members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            // å¥—é¤ç±»å‹æ˜ å°„
            const typeMap = {
                'trial': 'è¯•ç”¨',
                'weekly': 'å‘¨å¡',
                'monthly': 'æœˆå¡',
                'quarterly': 'å­£å¡',
                'yearly': 'å¹´å¡'
            };

            tbody.innerHTML = members.map(member => {
                const now = new Date();
                const endDate = new Date(member.end_date);
                const isActive = member.is_active && endDate > now;

                return `
                    <tr>
                        <td>${member.phone || '-'}</td>
                        <td>${typeMap[member.membership_type] || member.membership_type}</td>
                        <td>${formatDateTime(member.start_date)}</td>
                        <td>${formatDateTime(member.end_date)}</td>
                        <td class="${isActive ? 'active' : 'inactive'}">
                            ${isActive ? 'âœ“ æœ‰æ•ˆ' : 'âœ— è¿‡æœŸ'}
                        </td>
                        <td>${formatDateTime(member.updated_at)}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        // ç¿»é¡µ
        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                loadMemberList(newPage);
            }
        }
    </script>
</body>
</html>
