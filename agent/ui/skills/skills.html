<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen Bee - 技能</title>
    <link rel="stylesheet" href="/static/cdn_resourc/fontawesome/css/all.min.css">
    <script src="/static/cdn_resourc/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/static/chat/chat.css">
    <link rel="stylesheet" href="/static/skills/skills.css">
</head>
<body class="skills-page" data-require-auth>
    <div id="navbarContainer"></div>

    <main class="skills-main">
        <div class="skills-wrap">
            <div class="skills-sticky">
                <div class="skills-toolbar">
                    <div></div>
                    <div class="skills-search">
                        <i class="fas fa-search"></i>
                        <input id="skillSearch" type="text" placeholder="搜索技能">
                    </div>
                    <div></div>
                </div>

                <div class="skills-chips" id="skillsChips"></div>
            </div>

            <div class="skills-grid" id="skillsGrid"></div>
        </div>
    </main>

    <div class="modal" id="applyModal">
        <div class="drawer-backdrop active" onclick="closeApplyModal()"></div>
        <div class="modal-card">
            <div class="modal-body">
                <h3>选择安装对象</h3>
                <div class="select-field" id="agentSelect">
                    <input type="hidden" id="agentSelectValue" value="all">
                    <button type="button" class="select-trigger" aria-haspopup="listbox" aria-expanded="false">
                        <span class="select-label">全部智能体</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="select-options" role="listbox">
                        <button type="button" class="select-option is-selected" data-value="all">全部智能体</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="ghost-btn" onclick="closeApplyModal()">
                    <i class="fas fa-xmark"></i>
                    取消
                </button>
                <button class="primary-btn" onclick="confirmApply()">
                    <i class="fas fa-check"></i>
                    确认安装
                </button>
            </div>
        </div>
    </div>

    <div class="skill-detail-modal" id="skillDetailModal">
        <div class="skill-detail-backdrop" onclick="closeSkillDetail()"></div>
        <div class="skill-detail-card" role="dialog" aria-modal="true">
            <button class="detail-close" type="button" onclick="closeSkillDetail()" aria-label="关闭">
                <i class="fas fa-xmark"></i>
            </button>
            <div class="detail-media">
                <div class="detail-content-display">
                    <div id="detailContent" class="detail-content-text"></div>
                </div>
            </div>
            <div class="detail-content">
                <div class="detail-head">
                    <div>
                        <h2 id="detailTitle"></h2>
                        <p id="detailAuthor"></p>
                    </div>
                </div>
                <div class="detail-markdown" id="detailMarkdown"></div>
                <div class="detail-footer">
                    <div class="detail-reactions">
                        <button class="reaction-btn" type="button" data-action="like" onclick="reactSkill('like')" aria-label="点赞">
                            <i class="fas fa-thumbs-up"></i>
                            <span id="likeCount">0</span>
                        </button>
                        <button class="reaction-btn" type="button" data-action="dislike" onclick="reactSkill('dislike')" aria-label="点踩">
                            <i class="fas fa-thumbs-down"></i>
                            <span id="dislikeCount">0</span>
                        </button>
                        <button class="reaction-btn hidden" type="button" id="editSkillBtn" onclick="openEditSkill()" aria-label="编辑">
                            <i class="fas fa-pen"></i>
                            编辑
                        </button>
                        <button class="reaction-btn danger-btn hidden" type="button" id="deleteSkillBtn" onclick="deleteCurrentSkill()" aria-label="删除">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                    <button class="primary-btn detail-add" type="button" onclick="installSkill(detailState.id, event)">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑技能弹窗 -->
    <div id="editSkillModal" class="skill-publish-modal hidden">
        <div class="skill-publish-backdrop" onclick="closeEditSkill()"></div>
        <div class="skill-publish-card">
            <div class="skill-publish-header">
                <div class="skill-publish-title">编辑技能</div>
                <button class="skill-publish-close" onclick="closeEditSkill()" aria-label="关闭">&times;</button>
            </div>
            <div class="skill-publish-body">
                <div class="publish-media">
                    <div class="publish-editor-container">
                        <div class="publish-editor-toolbar">
                            <span class="editor-hint"><i class="fas fa-edit"></i> 技能详细介绍（支持 Markdown，可直接粘贴图片）</span>
                        </div>
                        <div class="publish-editor-wrapper">
                            <div id="editContentEditor" class="publish-content-editor" contenteditable="true"
                                 data-placeholder="在这里输入技能的详细介绍..."></div>
                        </div>
                    </div>
                </div>
                <div class="publish-form">
                    <div class="qb-form-row">
                        <label><i class="fas fa-tags"></i> 分类类型</label>
                        <div class="publish-tags" id="editTags"></div>
                    </div>
                    <div class="qb-form-row">
                        <label><i class="fab fa-markdown"></i> 技能描述（Markdown）</label>
                        <textarea id="editDesc" rows="10" placeholder="描述技能用途、能力范围、使用示例..."></textarea>
                    </div>
                </div>
            </div>
            <div class="skill-publish-footer">
                <button class="qb-btn qb-btn-secondary" onclick="closeEditSkill()">取消</button>
                <button class="qb-btn" onclick="submitEditSkill()">保存修改</button>
            </div>
        </div>
    </div>

    <script src="/static/api.js"></script>
    <script src="/static/auth-check.js"></script>
    <script src="/static/common.js"></script>
    <script>
        async function loadNavbar() {
            const container = document.getElementById('navbarContainer');
            if (!container) return;
            try {
                const resp = await fetch('/static/partials/navbar.html');
                container.innerHTML = await resp.text();
                const activeLink = container.querySelector('.nav-item[data-nav="skills"]');
                if (activeLink) activeLink.classList.add('active');
                if (window.initUserInfo) window.initUserInfo();
            } catch (err) {
                console.error('加载导航失败', err);
            }
        }

        function toggleUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) userMenu.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
        });

        document.addEventListener('click', function(e) {
            const userMenu = document.querySelector('.user-menu');
            if (!userMenu) return;
            if (!userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });

        document.addEventListener('click', function(e) {
            const item = e.target.closest('.nav-item');
            if (!item) return;
            const href = item.getAttribute('href') || '';
            if (href.startsWith('/')) {
                return;
            }
            e.preventDefault();
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            item.classList.add('active');
        });

        const detailState = {
            id: null,
            likeCount: 0,
            dislikeCount: 0,
            reacted: null,
            authorId: null,
            description: '',
            content: '',
            category: ''
        };
        const skillsState = {
            all: [],
            filtered: [],
            category: '',
            query: ''
        };
        const installState = {
            skillId: null,
            agents: []
        };

        function installSkill(id, event) {
            if (event) event.stopPropagation();
            const btn = event ? event.currentTarget : document.querySelector('.detail-add');
            if (btn) {
                btn.classList.remove('pulse');
                void btn.offsetWidth;
                btn.classList.add('pulse');
            }
            openApplyModal(id);
        }

        function openApplyModal(skillId) {
            installState.skillId = skillId || detailState.id;
            document.getElementById('applyModal').classList.add('active');
            loadInstallAgents();
        }

        function closeApplyModal() {
            document.getElementById('applyModal').classList.remove('active');
            closeAgentSelect();
        }

        async function confirmApply() {
            const selectedValue = document.getElementById('agentSelectValue')?.value || '';
            if (!selectedValue) {
                alert('请选择安装对象');
                return;
            }
            if (!installState.skillId) {
                alert('未选择技能');
                return;
            }
            try {
                await API.installSkill(installState.skillId, selectedValue);
                closeApplyModal();
                alert('安装成功');
            } catch (err) {
                alert(err.message || '安装失败');
            }
        }

        async function openSkillDetailById(id) {
            if (!id) return;
            const modal = document.getElementById('skillDetailModal');
            if (!modal) return;
            try {
                const res = await API.getSkillDetail(id);
                const skill = res.skill || {};
                detailState.id = id;
                detailState.likeCount = skill.like_count || 0;
                detailState.dislikeCount = skill.dislike_count || 0;
                detailState.reacted = skill.user_action || null;
                detailState.authorId = skill.author_id || null;
                detailState.description = skill.description || '';
                detailState.content = skill.content || '';
                detailState.category = skill.category || '';
                document.getElementById('detailTitle').textContent = skill.name || '';
                document.getElementById('detailAuthor').textContent = skill.author_name ? `作者 · ${skill.author_name}` : '';

                // 显示富文本内容（优先显示 content 字段，回退到 description）
                const content = skill.content || skill.description || '';
                document.getElementById('detailContent').innerHTML = content;

                document.getElementById('detailMarkdown').innerHTML = renderMarkdown(skill.description || '');
                updateReactionUI();
                updateDeleteButton();
                modal.classList.add('active');
                document.body.classList.add('modal-open');
            } catch (err) {
                alert(err.message || '加载失败');
            }
        }

        function closeSkillDetail() {
            const modal = document.getElementById('skillDetailModal');
            if (modal) modal.classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        async function reactSkill(action) {
            if (!detailState.id) return;
            updateReactionUI();
            try {
                const res = await API.reactSkill(detailState.id, action);
                detailState.likeCount = res.like_count ?? detailState.likeCount;
                detailState.dislikeCount = res.dislike_count ?? detailState.dislikeCount;
                detailState.reacted = res.action ?? null;
                updateReactionUI();
            } catch (err) {
                updateReactionUI();
                alert(err.message || '操作失败');
            }
        }

        function updateReactionUI() {
            const likeEl = document.getElementById('likeCount');
            const dislikeEl = document.getElementById('dislikeCount');
            if (likeEl) likeEl.textContent = detailState.likeCount || 0;
            if (dislikeEl) dislikeEl.textContent = detailState.dislikeCount || 0;
            document.querySelectorAll('.reaction-btn').forEach(btn => {
                const action = btn.dataset.action;
                btn.classList.toggle('active', detailState.reacted === action);
                btn.disabled = false;
            });
        }

        function updateDeleteButton() {
            const btn = document.getElementById('deleteSkillBtn');
            const editBtn = document.getElementById('editSkillBtn');
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!btn) return;
            const canDelete = user && detailState.authorId && user.id === detailState.authorId;
            btn.classList.toggle('hidden', !canDelete);
            if (editBtn) editBtn.classList.toggle('hidden', !canDelete);
        }

        async function deleteCurrentSkill() {
            if (!detailState.id) return;
            const confirmed = confirm('确定删除该技能吗？');
            if (!confirmed) return;
            try {
                await API.deleteSkill(detailState.id);
                skillsState.all = skillsState.all.filter(item => item.id !== detailState.id);
                applySkillFilter();
                closeSkillDetail();
            } catch (err) {
                alert(err.message || '删除失败');
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeSkillDetail();
        });

        const editState = {
            images: [],
            category: '',
            skillId: null
        };

        function openEditSkill() {
            if (!detailState.id) return;
            const modal = document.getElementById('editSkillModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            initEditSkillModal();
        }

        function closeEditSkill() {
            const modal = document.getElementById('editSkillModal');
            if (!modal) return;
            modal.classList.add('hidden');
        }

        function initEditSkillModal() {
            editState.images = [];
            editState.skillId = detailState.id;
            editState.category = detailState.category || '';

            const editor = document.getElementById('editContentEditor');
            if (editor) {
                editor.innerHTML = detailState.content || '';
            }
            const desc = document.getElementById('editDesc');
            if (desc) desc.value = detailState.description || '';
            loadEditCategories();
        }

        function selectEditCategory(button) {
            editState.category = button.dataset.value || '';
            document.querySelectorAll('#editTags .publish-tag').forEach(tag => tag.classList.remove('active'));
            button.classList.add('active');
        }

        function renderEditCategories(categories = []) {
            const container = document.getElementById('editTags');
            if (!container) return;
            if (!categories.length) {
                container.innerHTML = '<div style="color:#94a3b8;font-size:12px;">暂无分类</div>';
                return;
            }
            container.innerHTML = categories.map(name => `
                <button class="publish-tag" type="button" data-value="${name}" onclick="selectEditCategory(this)">${name}</button>
            `).join('');
            if (editState.category) {
                const active = container.querySelector(`[data-value="${editState.category}"]`);
                if (active) active.classList.add('active');
            }
        }

        async function loadEditCategories() {
            try {
                const data = await API.getSkillCategories();
                renderEditCategories(data.categories || []);
            } catch (err) {
                renderEditCategories([]);
            }
        }

        function buildEditorHtml(editor) {
            let markdownText = '';
            const imagePlaceholders = [];
            let imgIndex = 0;

            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    markdownText += node.textContent || '';
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    if (tagName === 'img') {
                        const placeholder = `![image](IMG_PLACEHOLDER_${imgIndex})`;
                        markdownText += placeholder;
                        imagePlaceholders[imgIndex] = node.outerHTML;
                        imgIndex += 1;
                    } else if (tagName === 'br') {
                        markdownText += '\n';
                    } else if (tagName === 'div' || tagName === 'p') {
                        for (let child of node.childNodes) {
                            processNode(child);
                        }
                        if (markdownText && !markdownText.endsWith('\n')) {
                            markdownText += '\n';
                        }
                    } else {
                        for (let child of node.childNodes) {
                            processNode(child);
                        }
                    }
                }
            }

            for (let child of editor.childNodes) {
                processNode(child);
            }

            let htmlContent;
            if (window.marked) {
                try {
                    htmlContent = window.marked.parse(markdownText);
                } catch (e) {
                    htmlContent = markdownText.replace(/\n/g, '<br>');
                }
            } else {
                htmlContent = markdownText.replace(/\n/g, '<br>');
            }

            imagePlaceholders.forEach((imgTag, index) => {
                const pattern = new RegExp(`<img[^>]*src=["']IMG_PLACEHOLDER_${index}["'][^>]*>`, 'gi');
                htmlContent = htmlContent.replace(pattern, imgTag);
            });

            return htmlContent;
        }

        async function submitEditSkill() {
            if (!editState.skillId) {
                alert('未选择技能');
                return;
            }
            const editor = document.getElementById('editContentEditor');
            if (!editor) {
                alert('编辑器未找到');
                return;
            }
            const htmlContent = buildEditorHtml(editor);
            const desc = document.getElementById('editDesc');
            const description = desc ? desc.value : '';

            const formData = new FormData();
            formData.append('description', description);
            formData.append('content', htmlContent);
            formData.append('category', editState.category || '');

            editState.images.forEach((item, index) => {
                if (item.file) {
                    const ext = item.file.name?.split('.').pop() || 'png';
                    const fileName = item.file.name || `image-${index + 1}.${ext}`;
                    formData.append('images', item.file, fileName);
                }
            });

            try {
                await API.updateSkill(editState.skillId, formData);
                const target = skillsState.all.find(item => item.id === editState.skillId);
                if (target) {
                    target.description = description;
                    target.category = editState.category || '';
                }
                detailState.description = description;
                detailState.content = htmlContent;
                detailState.category = editState.category || '';
                document.getElementById('detailContent').innerHTML = htmlContent;
                document.getElementById('detailMarkdown').innerHTML = renderMarkdown(description || '');
                applySkillFilter();
                closeEditSkill();
                alert('保存成功');
            } catch (err) {
                alert(err.message || '保存失败');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const editor = document.getElementById('editContentEditor');
            if (!editor) return;
            editor.addEventListener('paste', function(e) {
                e.preventDefault();
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                let hasImage = false;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        hasImage = true;
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';

                            const selection = window.getSelection();
                            if (selection.rangeCount > 0) {
                                const range = selection.getRangeAt(0);
                                range.deleteContents();
                                range.insertNode(img);
                                range.setStartAfter(img);
                                range.setEndAfter(img);
                                selection.removeAllRanges();
                                selection.addRange(range);
                            } else {
                                editor.appendChild(img);
                            }

                            editState.images.push({
                                file: file,
                                dataUrl: event.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
                if (!hasImage) {
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    document.execCommand('insertText', false, text);
                }
            });

            editor.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    document.execCommand('insertText', false, '    ');
                }
            });
        });

        async function loadSkills(category = '', query = '', mine = false) {
            const params = {};
            if (category) params.category = category;
            if (query) params.q = query;
            if (mine) params.mine = 'true';
            const res = await API.getSkillsList(params);
            skillsState.all = res.skills || [];
            applySkillFilter();
        }

        function applySkillFilter() {
            const term = skillsState.query.toLowerCase();
            skillsState.filtered = skillsState.all.filter(item => {
                const hay = `${item.name || ''} ${item.description || ''} ${item.author_name || ''}`.toLowerCase();
                return !term || hay.includes(term);
            });
            renderSkillGrid();
        }

        function renderSkillGrid() {
            const grid = document.getElementById('skillsGrid');
            if (!grid) return;
            if (!skillsState.filtered.length) {
                grid.innerHTML = '<div style="color:#94a3b8;font-size:13px;">暂无技能</div>';
                return;
            }

            // 生成随机头像颜色
            function generateAvatarColor(id) {
                const colors = [
                    '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444',
                    '#ec4899', '#6366f1', '#14b8a6', '#84cc16', '#f97316'
                ];
                let hash = 0;
                for (let i = 0; i < id.length; i++) {
                    hash = id.charCodeAt(i) + ((hash << 5) - hash);
                }
                return colors[Math.abs(hash) % colors.length];
            }

            // 格式化时间
            function formatTime(timeStr) {
                if (!timeStr) return '';
                const date = new Date(timeStr);
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                if (days === 0) return '今天';
                if (days === 1) return '昨天';
                if (days < 7) return `${days}天前`;
                if (days < 30) return `${Math.floor(days / 7)}周前`;
                return date.toLocaleDateString('zh-CN');
            }

            grid.innerHTML = skillsState.filtered.map(item => {
                const title = escapeHtml(item.name || '');
                const desc = escapeHtml((item.description || '').substring(0, 100));
                const author = escapeHtml(item.author_name || '匿名');
                const avatarColor = generateAvatarColor(item.id);
                const timeStr = formatTime(item.created_at);
                const firstChar = (item.name || '技')[0].toUpperCase();

                return `
                    <div class="skill-card" data-skill-id="${item.id}" onclick="openSkillDetailById('${item.id}')">
                        <div class="skill-body">
                            <div class="skill-header">
                                <div class="skill-avatar" style="background-color: ${avatarColor}">${firstChar}</div>
                                <div class="skill-info">
                                    <div class="skill-title">${title}</div>
                                    <div class="skill-time">${timeStr}</div>
                                </div>
                            </div>
                            <div class="skill-desc">${desc || '暂无描述'}</div>
                            <div class="skill-meta">
                                <span class="skill-author">${author}</span>
                                <div class="skill-actions">
                                    <button class="skill-reaction-btn" onclick="reactSkillFromCard('${item.id}', 'like', event)">
                                        <i class="fas fa-thumbs-up"></i>
                                        <span>${item.like_count || 0}</span>
                                    </button>
                                    <button class="skill-reaction-btn" onclick="reactSkillFromCard('${item.id}', 'dislike', event)">
                                        <i class="fas fa-thumbs-down"></i>
                                        <span>${item.dislike_count || 0}</span>
                                    </button>
                                    <button class="add-btn" onclick="installSkill('${item.id}', event)" title="安装技能" aria-label="安装技能">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function reactSkillFromCard(id, action, event) {
            if (event) event.stopPropagation();
            try {
                const res = await API.reactSkill(id, action);
                const target = skillsState.all.find(item => item.id === id);
                if (target) {
                    target.like_count = res.like_count ?? target.like_count;
                    target.dislike_count = res.dislike_count ?? target.dislike_count;
                }
                renderSkillGrid();
                if (detailState.id === id) {
                    detailState.likeCount = res.like_count ?? detailState.likeCount;
                    detailState.dislikeCount = res.dislike_count ?? detailState.dislikeCount;
                    detailState.reacted = res.action ?? null;
                    updateReactionUI();
                }
            } catch (err) {
                alert(err.message || '操作失败');
            }
        }

        function renderSkillChips(categories = []) {
            const container = document.getElementById('skillsChips');
            if (!container) return;
            const all = ['全部', '我发布的', ...categories];
            container.innerHTML = all.map((name, index) => `
                <button class="chip ${index === 0 ? 'active' : ''}" data-value="${name}">${name}</button>
            `).join('');
            container.querySelectorAll('.chip').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
                    btn.classList.add('active');
                    const value = btn.dataset.value;
                    skillsState.category = value === '全部' ? '' : value;
                    if (value === '我发布的') {
                        loadSkills('', skillsState.query, true);
                    } else {
                        loadSkills(skillsState.category, skillsState.query, false);
                    }
                });
            });
        }


        async function initSkillsPage() {
            try {
                const categoriesRes = await API.getSkillCategories();
                renderSkillChips(categoriesRes.categories || []);
            } catch (err) {
                renderSkillChips([]);
            }
            await loadSkills();
        }

        function escapeHtml(str) {
            return (str || '').replace(/[&<>"']/g, s => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[s]));
        }

        function renderMarkdown(text) {
            const lines = (text || '').split('\n');
            let html = '';
            let inList = false;
            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    return;
                }
                if (trimmed.startsWith('- ')) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${escapeHtml(trimmed.slice(2))}</li>`;
                    return;
                }
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
                if (trimmed.startsWith('### ')) {
                    html += `<h4>${escapeHtml(trimmed.slice(4))}</h4>`;
                } else if (trimmed.startsWith('## ')) {
                    html += `<h3>${escapeHtml(trimmed.slice(3))}</h3>`;
                } else if (trimmed.startsWith('# ')) {
                    html += `<h2>${escapeHtml(trimmed.slice(2))}</h2>`;
                } else {
                    html += `<p>${escapeHtml(trimmed)}</p>`;
                }
            });
            if (inList) html += '</ul>';
            return html || '<p>暂无描述</p>';
        }

        function toggleAgentSelect() {
            const select = document.getElementById('agentSelect');
            if (!select) return;
            select.classList.toggle('open');
            const trigger = select.querySelector('.select-trigger');
            if (trigger) trigger.setAttribute('aria-expanded', select.classList.contains('open'));
        }

        function closeAgentSelect() {
            const select = document.getElementById('agentSelect');
            if (!select) return;
            select.classList.remove('open');
            const trigger = select.querySelector('.select-trigger');
            if (trigger) trigger.setAttribute('aria-expanded', 'false');
        }

        async function loadInstallAgents() {
            const user = window.getCurrentUser ? window.getCurrentUser() : null;
            if (!user || !user.id) {
                renderAgentOptions([]);
                return;
            }
            const label = document.querySelector('#agentSelect .select-label');
            if (label) label.textContent = '加载中...';
            try {
                let res = await API.getAgentListByUser(user.id);
                let agents = res.agents || [];
                if (!agents.length) {
                    await API.initUserAgents(user.id);
                    res = await API.getAgentListByUser(user.id);
                    agents = res.agents || [];
                }
                installState.agents = agents;
                renderAgentOptions(installState.agents);
            } catch (err) {
                renderAgentOptions([]);
            }
        }

        function renderAgentOptions(agents) {
            const select = document.getElementById('agentSelect');
            if (!select) return;
            const options = select.querySelector('.select-options');
            const label = select.querySelector('.select-label');
            const input = document.getElementById('agentSelectValue');
            if (!options || !label || !input) return;
            if (!agents || !agents.length) {
                options.innerHTML = '<button type="button" class="select-option is-selected" data-value="all">全部智能体</button>';
                label.textContent = '全部智能体';
                input.value = 'all';
                return;
            }
            options.innerHTML = [
                '<button type="button" class="select-option is-selected" data-value="all">全部智能体</button>',
                ...agents.map(agent => `
                    <button type="button" class="select-option" data-value="${agent.id}">
                        ${agent.username || '未命名智能体'}
                    </button>
                `)
            ].join('');
            label.textContent = '全部智能体';
            input.value = 'all';
        }

        document.addEventListener('click', function(e) {
            const select = document.getElementById('agentSelect');
            if (!select) return;
            const trigger = select.querySelector('.select-trigger');
            if (trigger && trigger.contains(e.target)) {
                e.preventDefault();
                toggleAgentSelect();
                return;
            }
            if (select.contains(e.target)) {
                const option = e.target.closest('.select-option');
                if (option) {
                    select.querySelectorAll('.select-option').forEach(item => item.classList.remove('is-selected'));
                    option.classList.add('is-selected');
                    const label = select.querySelector('.select-label');
                    const input = document.getElementById('agentSelectValue');
                    if (label) label.textContent = option.textContent.trim();
                    if (input) input.value = option.dataset.value || 'all';
                    closeAgentSelect();
                }
                return;
            }
            closeAgentSelect();
        });

        document.getElementById('skillSearch').addEventListener('input', function(e) {
            skillsState.query = e.target.value.trim();
            applySkillFilter();
        });

        document.addEventListener('DOMContentLoaded', function() {
            initSkillsPage();
        });

    </script>
</body>
</html>
